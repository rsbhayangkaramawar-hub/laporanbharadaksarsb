<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVIP Bharadaksa - Realtime v9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zBIqZLRpQPBq6psw_Z3oGZ_SK_X0rfQ",
            authDomain: "bhara-daksa.firebaseapp.com",
            databaseURL: "https://bhara-daksa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bhara-daksa",
            storageBucket: "bhara-daksa.firebasestorage.app",
            messagingSenderId: "765829225964",
            appId: "1:765829225964:web:acb32bf51f69bfe766f4c9",
            measurementId: "G-GCYRJT9SFS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const rooms = [
            "BHARA DAKSA 01", "BHARA DAKSA 02", "BHARA DAKSA 03", "BHARA DAKSA 04",
            "BHARA DAKSA 05-A", "BHARA DAKSA 05-B", "BHARA DAKSA 06-A", "BHARA DAKSA 06-B",
            "BHARA DAKSA 07-A", "BHARA DAKSA 07-B", "BHARA DAKSA 08-A", "BHARA DAKSA 08-B"
        ];

        let patients = {};
        let currentRoom = null;

        // --- REALTIME SYNC: PASIEN ---
        onValue(ref(db, 'patients'), (snapshot) => {
            patients = snapshot.val() || {};
            renderGrid();
        });

        // --- REALTIME SYNC: DOKTER ---
        onValue(ref(db, 'doctors'), (snapshot) => {
            const docList = snapshot.val() || {};
            renderDoctorUI(docList);
        });

        // Fungsi Tambah Dokter
        window.addDoctor = () => {
            const name = document.getElementById('newDocName').value;
            if(name) {
                push(ref(db, 'doctors'), { name: name });
                document.getElementById('newDocName').value = '';
            }
        };

        // Fungsi Hapus Dokter
        window.removeDoc = (id) => {
            if(confirm("Hapus dokter dari daftar?")) {
                remove(ref(db, `doctors/${id}`));
            }
        };

        function renderDoctorUI(docs) {
            const listUI = document.getElementById('docList');
            const selectUI = document.getElementById('dpjpSelect');
            listUI.innerHTML = '';
            selectUI.innerHTML = '<option value="">-- PILIH DPJP --</option>';
            
            for(let id in docs) {
                const doc = docs[id];
                listUI.innerHTML += `
                    <li class="flex justify-between items-center bg-white/5 p-2 rounded-lg text-[10px]">
                        <span class="font-bold text-cyan-400">${doc.name}</span>
                        <button onclick="removeDoc('${id}')" class="text-red-500 hover:text-red-300 px-2">‚úï</button>
                    </li>`;
                selectUI.innerHTML += `<option value="${doc.name}">${doc.name}</option>`;
            }
        }

        // Simpan Pasien
        window.savePatient = (e) => {
            e.preventDefault();
            const r = document.getElementById('ruangSelect').value;
            const data = {
                nama: document.getElementById('nama').value,
                umur: document.getElementById('umur').value,
                diagnosa: document.getElementById('diagnosa').value,
                penjamin: document.getElementById('penjamin').value,
                dpjp: document.getElementById('dpjpSelect').value,
                catatan: "Belum ada catatan."
            };
            set(ref(db, 'patients/' + r.replace(/\s+/g, '_')), data);
            document.getElementById('patientForm').reset();
        };

        window.saveNote = () => {
            update(ref(db, 'patients/' + currentRoom.replace(/\s+/g, '_')), {
                catatan: document.getElementById('noteInput').value || "Belum ada catatan."
            });
            closeModal();
        };

        window.checkoutPatient = () => {
            const key = currentRoom.replace(/\s+/g, '_');
            if(confirm(`Pulangkan pasien ${patients[key].nama}?`)) {
                remove(ref(db, 'patients/' + key));
                closeModal();
            }
        };

        function renderGrid() {
            const grid = document.getElementById('patientGrid');
            const rSelect = document.getElementById('ruangSelect');
            grid.innerHTML = ''; rSelect.innerHTML = '<option value="">-- PILIH BED --</option>';
            let count = 0;

            rooms.forEach(room => {
                const key = room.replace(/\s+/g, '_');
                const p = patients[key];
                if (p) {
                    count++;
                    grid.innerHTML += `
                        <div onclick="openModal('${room}')" class="box-bed box-terisi flex flex-col scale-in">
                            <div class="box-header">${room}</div>
                            <div class="p-4 flex-1 flex flex-col">
                                <h4 class="text-base font-black text-white uppercase truncate">${p.nama}</h4>
                                <p class="text-[11px] text-blue-200 font-bold">${p.umur} Thn | ${p.penjamin}</p>
                                <p class="text-[11px] text-white font-bold italic mt-2">${p.diagnosa || '-'}</p>
                                <p class="text-[10px] text-cyan-400 font-black mt-1 uppercase tracking-tight">${p.dpjp || '-'}</p>
                                <div class="bg-black/40 border-l-2 border-yellow-500 p-2 rounded mt-2 flex-1">
                                    <p class="text-[11px] text-yellow-500 font-bold whitespace-pre-wrap leading-tight">${p.catatan}</p>
                                </div>
                            </div>
                        </div>`;
                } else {
                    rSelect.innerHTML += `<option value="${room}">${room}</option>`;
                    grid.innerHTML += `<div class="box-bed flex items-center justify-center opacity-20 border-2 border-dashed border-white/20"><div class="box-header absolute top-0 w-full">${room}</div><p class="text-[10px] font-black text-gray-500">KOSONG</p></div>`;
                }
            });
            document.getElementById('borStat').innerText = `${count} / 12 (${Math.round((count/12)*100)}%)`;
        }

        window.openModal = (r) => {
            currentRoom = r;
            const p = patients[r.replace(/\s+/g, '_')];
            document.getElementById('modalTitle').innerText = r;
            document.getElementById('modalPatientSub').innerText = `${p.nama} (${p.umur} Thn)`;
            document.getElementById('noteInput').value = p.catatan === "Belum ada catatan." ? "" : p.catatan;
            document.getElementById('modalOverlay').style.display = 'flex';
        };
        window.closeModal = () => document.getElementById('modalOverlay').style.display = 'none';

        setInterval(() => {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.toLocaleTimeString('id-ID');
            document.getElementById('liveDay').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        window.sendWhatsApp = () => {
            let msg = `*LAPORAN VVIP BHARADAKSA*%0AüìÖ _${document.getElementById('liveDay').innerText}_%0Aüìä *BOR:* ${document.getElementById('borStat').innerText}%0A%0A*üè• STATUS BED:*%0A`;
            rooms.forEach((r, i) => {
                const p = patients[r.replace(/\s+/g, '_')];
                msg += `${i+1}. ${r}: ${p ? '*TERISI* ('+p.nama+')' : '_KOSONG_' }%0A`;
            });
            msg += `%0A*üìù DETAIL PASIEN:*%0A%0A`;
            for(let key in patients) {
                let p = patients[key];
                msg += `*${key.replace(/_/g, ' ')}*%0Aüë§ ${p.nama}%0Aü©∫ ${p.diagnosa}%0Aüë®‚Äç‚öïÔ∏è DPJP: ${p.dpjp}%0Aüìù Catatan: _${p.catatan.replace(/\n/g, '%0A')}_%0A%0A`;
            }
            window.open(`https://wa.me/?text=${msg}`, '_blank');
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: white; height: 100vh; overflow: hidden; }
        .sidebar-section { background-color: #0f172a; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .input-dark { background-color: #1e293b; border: 1px solid #334155; color: white; font-size: 0.75rem; }
        .box-bed { background-color: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; position: relative; min-height: 240px; transition: 0.3s; cursor: pointer; }
        .box-terisi { background-color: #1e3a8a; border: 1px solid #3b82f6; box-shadow: 0 0 20px rgba(59,130,246,0.15); }
        .box-header { text-align: center; padding: 6px; border-bottom: 1px solid rgba(251,191,36,0.2); color: #fbbf24; font-weight: 800; font-size: 0.75rem; }
        #modalOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @media (max-width: 768px) { body { overflow-y: auto; height: auto; } .flex-row-mobile { flex-direction: column; } aside { width: 100% !important; } .grid-mobile { grid-template-columns: 1fr !important; } }
    </style>
</head>
<body class="flex flex-row-mobile p-4 gap-6">

    <aside class="w-1/4 flex flex-col">
        <div class="mb-4">
            <h1 class="text-xl font-black text-yellow-500 italic uppercase">VVIP BHARADAKSA</h1>
            <p id="liveDay" class="text-[10px] text-blue-400 font-bold uppercase"></p>
            <p id="liveClock" class="text-2xl font-black font-mono"></p>
        </div>

        <div class="sidebar-section">
            <h3 class="text-[9px] text-yellow-500 font-bold uppercase mb-2">Input Pasien</h3>
            <form id="patientForm" onsubmit="savePatient(event)" class="space-y-2">
                <input type="text" id="nama" placeholder="NAMA PASIEN" class="input-dark w-full p-2 rounded-lg" required>
                <div class="flex gap-2">
                    <input type="number" id="umur" placeholder="Umur" class="input-dark w-1/3 p-2 rounded-lg">
                    <select id="penjamin" class="input-dark w-2/3 p-2 rounded-lg">
                        <option>BPJS</option><option>UMUM</option><option>POLRI</option><option>ASURANSI</option>
                    </select>
                </div>
                <select id="dpjpSelect" class="input-dark w-full p-2 rounded-lg" required></select>
                <input type="text" id="diagnosa" placeholder="Diagnosa Utama" class="input-dark w-full p-2 rounded-lg">
                <select id="ruangSelect" class="input-dark w-full p-2 rounded-lg" required></select>
                <button type="submit" class="bg-yellow-500 text-black w-full py-2.5 rounded-xl font-bold text-xs uppercase shadow-lg">Simpan Pasien</button>
            </form>
        </div>

        <div class="sidebar-section">
            <h3 class="text-[9px] text-yellow-500 font-bold uppercase mb-2">Manajemen DPJP</h3>
            <div class="flex gap-1 mb-3">
                <input type="text" id="newDocName" placeholder="Nama Dokter..." class="input-dark flex-1 p-2 rounded-lg">
                <button onclick="addDoctor()" class="bg-cyan-600 px-3 rounded-lg font-bold">+</button>
            </div>
            <ul id="docList" class="space-y-1 max-h-32 overflow-y-auto pr-1"></ul>
        </div>

        <button onclick="sendWhatsApp()" class="bg-green-600 w-full py-3.5 rounded-xl font-bold text-xs uppercase flex items-center justify-center gap-2 shadow-lg">
            <i class="fab fa-whatsapp text-lg"></i> Laporan WA
        </button>
    </aside>

    <main class="flex-1">
        <div class="mb-3 flex justify-between items-end px-2">
            <span class="text-[9px] text-yellow-500 font-bold uppercase tracking-widest">Command Center v9</span>
            <span class="text-xs font-black uppercase">BOR: <span id="borStat" class="text-blue-400"></span></span>
        </div>
        <div id="patientGrid" class="grid grid-cols-4 grid-mobile gap-4"></div>
    </main>

    <div id="modalOverlay" onclick="if(event.target == this) closeModal()">
        <div class="bg-[#0f172a] border border-blue-500 p-8 rounded-3xl w-full max-w-sm">
            <h2 id="modalTitle" class="text-2xl font-black text-yellow-500 uppercase"></h2>
            <p id="modalPatientSub" class="text-xs text-blue-300 font-bold mb-4"></p>
            <textarea id="noteInput" rows="7" class="input-dark w-full p-4 rounded-xl mb-4 text-xs leading-relaxed" placeholder="Ketik catatan medis..."></textarea>
            <div class="flex gap-3 mb-6">
                <button onclick="closeModal()" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold text-xs">BATAL</button>
                <button onclick="saveNote()" class="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-bold text-xs uppercase">SIMPAN</button>
            </div>
            <div class="border-t border-white/5 pt-4 flex justify-center">
                <button onclick="checkoutPatient()" class="text-red-500 border border-red-500/30 px-4 py-2 rounded-lg text-[9px] font-bold uppercase">üö™ Kosongkan Bed</button>
            </div>
        </div>
    </div>

</body>
</html>
